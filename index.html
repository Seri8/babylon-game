<!doctype html>
const railRight = railLeft.clone("railR");
railRight.position.x = 0.7;


const pipeMat = new BABYLON.PBRMaterial("pipeMat", scene);
pipeMat.albedoTexture = new BABYLON.Texture("assets/metal.jpg", scene);
pipeMat.bumpTexture = new BABYLON.Texture("assets/metalNormal.jpg", scene);
pipeMat.metallic = 1;
pipeMat.roughness = 0.3;
for(let i=0;i<tunnelLength;i+=15){
const pipe = BABYLON.MeshBuilder.CreateCylinder("pipe"+i,{diameter:0.15,height:2},scene);
pipe.rotation.z = Math.PI/2;
pipe.position = new BABYLON.Vector3(-2.5,0.5,i*2);
pipe.material = pipeMat;
}


scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
scene.fogDensity = 0.01;
scene.fogColor = new BABYLON.Color3(0.1,0.1,0.1);


const particleSystem = new BABYLON.ParticleSystem("dust",1000,scene);
particleSystem.particleTexture = new BABYLON.Texture("assets/flare.png",scene);
particleSystem.emitter = new BABYLON.Vector3(0,1,0);
particleSystem.minEmitBox = new BABYLON.Vector3(-3,0,0);
particleSystem.maxEmitBox = new BABYLON.Vector3(3,2,tunnelLength*2);
particleSystem.color1 = new BABYLON.Color4(1,1,1,0.05);
particleSystem.color2 = new BABYLON.Color4(1,1,1,0.05);
particleSystem.minSize = 0.01;
particleSystem.maxSize = 0.03;
particleSystem.minLifeTime = 2;
particleSystem.maxLifeTime = 4;
particleSystem.emitRate = 200;
particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_STANDARD;
particleSystem.direction1 = new BABYLON.Vector3(0,0,1);
particleSystem.direction2 = new BABYLON.Vector3(0,0,1);
particleSystem.gravity = new BABYLON.Vector3(0,0,0);
particleSystem.start();


let u=0;
scene.registerBeforeRender(()=>{
u+=0.02;
if(u>tunnelLength*2) u=0;
camera.position.z = u;
camera.position.y = 1;
lights.forEach(lamp=>{ lamp.intensity = 1.8 + Math.random()*0.4; });
});


return scene;
};


const scene = createScene();
engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
