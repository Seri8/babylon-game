<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Optimized Subway Tunnel</title>
  <style>
    html, body { width:100%; height:100%; margin:0; overflow:hidden; background:#000; }
    #renderCanvas { width:100%; height:100%; display:block; }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);
    engine.setHardwareScalingLevel(2); // render at lower resolution for speed

    const createScene = function () {
      const scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color4(0.02,0.02,0.02,1);

      // Camera
      const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,1.5,0), scene);
      camera.fov = 0.85;

      // Ambient light only (very cheap)
      const ambient = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
      ambient.intensity = 0.3;

      // Shorter tunnel & simpler geometry
      const path = [];
      const tunnelLength = 150; // smaller for performance
      for (let i=0; i<tunnelLength; i++) {
        const x = Math.sin(i*0.1) * 1.5;
        const y = Math.cos(i*0.05) * 0.3;
        const z = i * 2;
        path.push(new BABYLON.Vector3(x, y, z));
      }

      const tunnel = BABYLON.MeshBuilder.CreateTube("tunnel", {
        path: path,
        radius: 3,
        tessellation: 16,  // fewer polygons
        sideOrientation: BABYLON.Mesh.BACKSIDE
      }, scene);

      const tunnelMat = new BABYLON.StandardMaterial("tunnelMat", scene);
      tunnelMat.diffuseColor = new BABYLON.Color3(0.25,0.25,0.25);
      tunnelMat.specularColor = new BABYLON.Color3(0,0,0);
      tunnel.material = tunnelMat;

      // Emissive ceiling bulbs (no point lights)
      const bulbMat = new BABYLON.StandardMaterial("bulbMat", scene);
      bulbMat.emissiveColor = new BABYLON.Color3(1, 0.9, 0.7);
      for (let i=0; i<tunnelLength; i+=20) {
        const bulb = BABYLON.MeshBuilder.CreateSphere("bulb"+i,{diameter:0.3},scene);
        const pos = path[i];
        bulb.position = new BABYLON.Vector3(pos.x, 2.2, pos.z);
        bulb.material = bulbMat;
      }

      // Subtle fog
      scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
      scene.fogDensity = 0.006;
      scene.fogColor = new BABYLON.Color3(0.05,0.05,0.05);

      // Very light dust particles
      const particleSystem = new BABYLON.ParticleSystem("dust", 400, scene);
      particleSystem.particleTexture = new BABYLON.Texture("https://playground.babylonjs.com/textures/flare.png",scene);
      particleSystem.emitter = new BABYLON.Vector3(0,1,0);
      particleSystem.minEmitBox = new BABYLON.Vector3(-3,0,0);
      particleSystem.maxEmitBox = new BABYLON.Vector3(3,2,tunnelLength*2);
      particleSystem.color1 = new BABYLON.Color4(1,1,1,0.04);
      particleSystem.color2 = new BABYLON.Color4(1,1,1,0.04);
      particleSystem.minSize = 0.01;
      particleSystem.maxSize = 0.02;
      particleSystem.emitRate = 100;
      particleSystem.start();

      // Camera animation
      let u=0;
      scene.registerBeforeRender(()=>{
        u += 0.25;
        if (u > tunnelLength * 2) u = 0;

        const idx = Math.floor(u / 2) % path.length;
        const pos = path[idx];
        camera.position.set(pos.x, 1.5, pos.z);
      });

      return scene;
    };

    const scene = createScene();
    engine.runRenderLoop(()=>scene.render());
    window.addEventListener("resize",()=>engine.resize());
  </script>
</body>
</html>
