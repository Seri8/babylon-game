<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Realistic Subway Tunnel Ride</title>
  <style>
    html, body { width:100%; height:100%; margin:0; overflow:hidden; background:#000; }
    #renderCanvas { width:100%; height:100%; display:block; }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
    engine.setHardwareScalingLevel(1.5);

    const createScene = function () {
      const scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color4(0, 0, 0, 1);

      // Camera
      const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,1.5,0), scene);
      camera.fov = 0.85;

      // Lighting
      new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);

      // Tunnel path
      const path = [];
      const tunnelLength = 150;
      for (let i = 0; i < tunnelLength; i++) {
        const x = Math.sin(i * 0.1) * 1.5;
        const y = Math.cos(i * 0.05) * 0.3;
        const z = i * 2;
        path.push(new BABYLON.Vector3(x, y, z));
      }

      // Solid tunnel
      const solidMat = new BABYLON.StandardMaterial("solidMat", scene);
      solidMat.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.12);
      solidMat.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
      solidMat.emissiveColor = new BABYLON.Color3(0.15, 0.2, 0.25);
      solidMat.alpha = 0.95;

      const solidTunnel = BABYLON.MeshBuilder.CreateTube("solidTunnel", {
        path: path,
        radius: 3,
        tessellation: 64,
        sideOrientation: BABYLON.Mesh.BACKSIDE
      }, scene);
      solidTunnel.material = solidMat;

      // Grid floor
      const gridMat = new BABYLON.StandardMaterial("gridMat", scene);
      gridMat.emissiveColor = new BABYLON.Color3(0.2, 0.8, 1);
      gridMat.wireframe = true;
      const floor = BABYLON.MeshBuilder.CreateGround("floor", { width: 6, height: 1000, subdivisions: 100 }, scene);
      floor.position.y = -3;
      floor.material = gridMat;

      // Rails
      const railMat = new BABYLON.StandardMaterial("railMat", scene);
      railMat.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
      railMat.specularColor = new BABYLON.Color3(0.8,0.8,0.8);
      const railLeft = BABYLON.MeshBuilder.CreateBox("railL", {width:0.1, height:0.05, depth:tunnelLength*2}, scene);
      railLeft.position = new BABYLON.Vector3(-0.5, -2.95, tunnelLength);
      railLeft.material = railMat;
      const railRight = railLeft.clone("railR");
      railRight.position.x = 0.5;

      // Ceiling lights
      const lightMat = new BABYLON.StandardMaterial("lightMat", scene);
      lightMat.emissiveColor = new BABYLON.Color3(1, 1, 0.85);
      for (let i = 0; i < tunnelLength; i += 15) {
        const pos = path[i];
        const lightSphere = BABYLON.MeshBuilder.CreateSphere("light"+i, {diameter:0.2}, scene);
        lightSphere.position = new BABYLON.Vector3(pos.x, 2.5, pos.z);
        lightSphere.material = lightMat;

        const light = new BABYLON.PointLight("lamp"+i, lightSphere.position, scene);
        light.intensity = 1.5;
        light.diffuse = new BABYLON.Color3(1, 0.95, 0.8);
      }

      // Fog
      scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
      scene.fogDensity = 0.006;
      scene.fogColor = new BABYLON.Color3(0.02,0.02,0.02);

      // Camera subway ride animation
      let u = 0;
      let hue = 0;
      scene.registerBeforeRender(() => {
        u += 0.4; // forward speed
        if (u > tunnelLength * 2) u = 0;
        const idx = Math.floor(u / 2) % path.length;
        const pos = path[idx];

        // Bobbing and banking
        const bob = Math.sin(u * 0.2) * 0.1;
        const bank = Math.sin(u * 0.1) * 0.05;
        camera.position.set(pos.x + bank, 1.5 + bob, pos.z);

        // Rotation along curve
        if (idx < path.length - 1) {
          const next = path[idx + 1];
          const forward = next.subtract(pos).normalize();
          camera.rotation.y = Math.atan2(forward.x, forward.z) + bank;
        }

        // Color cycling for tunnel and grid
        hue = (hue + 0.8) % 360;
        solidMat.emissiveColor = BABYLON.Color3.FromHSV(hue / 360, 1, 0.9);
        gridMat.emissiveColor = BABYLON.Color3.FromHSV((hue + 180) / 360, 0.8, 0.9);
      });

      return scene;
    };

    const scene = createScene();
    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
